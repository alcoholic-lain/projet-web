<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Space - Telegram VM</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } } }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        .emoji-picker {
            display: none; position: absolute; bottom: 70px; left: 16px;
            background: white; dark:bg-gray-800; border: 1px solid #e5e7eb; dark:border-gray-700;
            border-radius: 12px; padding: 12px; box-shadow: 0 10px 25px rgba(0,0,0,.1);
            z-index: 100; max-width: 320px; flex-wrap: wrap; gap: 8px; font-size: 20px;
        }
        .emoji-picker.show { display: flex; }

        .attachment-preview { max-width: 120px; max-height: 120px; border-radius: 8px; margin-top: 8px; }

        /* DM Popup */
        #dm-popup {
            position: fixed; bottom: 20px; right: 20px; width: 380px; height: 500px;
            background: white; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            display: none; flex-direction: column; z-index: 1000; transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        .dark #dm-popup { background: #111827; border-color: #374151; }
        #dm-popup.maximized { width: 800px; height: 650px; }
        #dm-popup.minimized { height: 60px; }

        .drag-handle { cursor: move; }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 16px; height: 16px; cursor: se-resize; }
        .resize-handle::after { content: ''; position: absolute; right: 4px; bottom: 4px; border-right: 8px solid #9ca3af; border-bottom: 8px solid #9ca3af; border-left: 8px solid transparent; border-top: 8px solid transparent; }

        /* DM Button */
        #dm-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #3b82f6; color: white; border-radius: 50%; box-shadow: 0 10px 20px rgba(59,130,246,0.3); display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 999; transition: all 0.3s ease; }
        #dm-btn:hover { transform: scale(1.1); }

        /* Telegram Voice Message */
        .voice-container {
            display: flex; align-items: center; gap: 8px; min-width: 120px; max-width: 300px; height: 36px;
            background: #e6f3ff; dark:background: #2f2f2f; border-radius: 18px; padding: 0 12px;
            font-size: 13px; color: #0066cc; dark:color: #8ab4f8;
            font-weight: 500;
        }
        .dark .voice-container { color: #8ab4f8; }

        .play-btn {
            width: 24px; height: 24px; border-radius: 50%; background: #3390ec; color: white;
            display: flex; align-items: center; justify-content: center; font-size: 11px;
            cursor: pointer; transition: background 0.2s;
        }
        .dark .play-btn { background: #8ab4f8; }

        .voice-wave {
            flex: 1; height: 28px; display: flex; align-items: center; gap: 1px; cursor: pointer;
        }
        .voice-bar {
            width: 2px; background: #3390ec; dark:background: #8ab4f8; border-radius: 1px;
            height: 4px; animation: telegram-wave 1.4s infinite ease-in-out;
            transform-origin: bottom;
        }
        .dark .voice-bar { background: #8ab4f8; }

        .voice-bar:nth-child(1) { animation-delay: 0s; height: 6px; }
        .voice-bar:nth-child(2) { animation-delay: 0.1s; height: 12px; }
        .voice-bar:nth-child(3) { animation-delay: 0.2s; height: 18px; }
        .voice-bar:nth-child(4) { animation-delay: 0.3s; height: 14px; }
        .voice-bar:nth-child(5) { animation-delay: 0.4s; height: 8px; }
        .voice-bar:nth-child(6) { animation-delay: 0.5s; height: 10px; }
        .voice-bar:nth-child(7) { animation-delay: 0.6s; height: 16px; }
        .voice-bar:nth-child(8) { animation-delay: 0.7s; height: 20px; }
        .voice-bar:nth-child(9) { animation-delay: 0.8s; height: 16px; }
        .voice-bar:nth-child(10) { animation-delay: 0.9s; height: 10px; }

        @keyframes telegram-wave {
            0%, 100% { transform: scaleY(1); opacity: 0.7; }
            50% { transform: scaleY(0.3); opacity: 1; }
        }

        .time-counter {
            min-width: 46px; text-align: right; font-size: 12px;
        }

        /* 3-dot Menu */
        .message-actions { opacity: 0; transition: opacity 0.2s; }
        .message-item:hover .message-actions { opacity: 1; }
        .dropdown-menu {
            position: absolute; right: 0; top: 100%; background: white; dark:bg-gray-800;
            border: 1px solid #e5e7eb; dark:border-gray-700; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 160px; z-index: 50; display: none;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 8px 12px; cursor: pointer; font-size: 14px; }
        .dropdown-item:hover { background: #f3f4f6; dark:background: #374151; }

        /* Contact Highlight */
        .contact-item.active { background: #eef2ff; dark:background: #374151; }

        /* Empty State */
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; text-align: center; padding: 2rem; color: #9ca3af; dark:color: #9ca3af;
        }
        .empty-state svg {
            width: 64px; height: 64px; margin-bottom: 1.5rem;
            fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
        }
        .empty-state h3 {
            font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;
        }
        .empty-state p {
            font-size: 0.875rem; margin-bottom: 1.5rem;
        }
        .empty-state button {
            background: #3b82f6; color: white; padding: 0.5rem 1.5rem; border-radius: 9999px;
            font-weight: 500; transition: background 0.2s;
        }
        .empty-state button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 min-h-screen">

<!-- ==================== NAVBAR ==================== -->
<header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <div class="flex items-center space-x-8">
                <h1 class="text-2xl font-bold text-indigo-600">Space</h1>
                <nav class="hidden md:flex space-x-6">
                    <a href="#" class="text-gray-700 dark:text-gray-300 hover:text-indigo-600 font-medium">Home</a>
                    <a href="categories.html" class="text-gray-700 dark:text-gray-300 hover:text-indigo-600 font-medium">Categories</a>
                    <a href="#" class="text-gray-700 dark:text-gray-300 hover:text-indigo-600 font-medium">Messages</a>
                </nav>
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-moon"></i></button>
            </div>
        </div>
    </div>
</header>

<!-- ==================== HERO ==================== -->
<section class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white py-24">
    <div class="max-w-7xl mx-auto px-4 text-center">
        <h2 class="text-5xl font-bold mb-4">Private. Fast. Beautiful.</h2>
        <p class="text-xl mb-8">Messaging, reimagined.</p>
    </div>
</section>

<!-- ==================== DM BUTTON ==================== -->
<div id="dm-btn" class="shadow-lg">
    <i class="fas fa-comment-dots"></i>
</div>

<!-- ==================== DM POPUP ==================== -->
<div id="dm-popup" class="rounded-2xl overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-3 flex items-center justify-between drag-handle">
        <div class="flex items-center space-x-3">
            <button id="back-to-list" class="p-1.5 hover:bg-white/20 rounded hidden"><i class="fas fa-arrow-left"></i></button>
            <img id="popup-avatar" src="" alt="" class="w-8 h-8 rounded-full"/>
            <div>
                <h3 id="popup-name" class="font-semibold text-sm">Messages</h3>
                <p id="popup-status" class="text-xs opacity-90"></p>
            </div>
        </div>
        <div class="flex space-x-1">
            <button id="minimize-btn" class="p-1.5 hover:bg-white/20 rounded"><i class="fas fa-minus"></i></button>
            <button id="maximize-btn" class="p-1.5 hover:bg-white/20 rounded"><i class="fas fa-expand"></i></button>
            <button id="close-popup" class="p-1.5 hover:bg-white/20 rounded"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- Layout -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Contact List -->
        <div id="contact-sidebar" class="w-80 bg-white dark:bg-gray-800 border-r dark:border-gray-700 overflow-y-auto">
            <div class="p-3 border-b dark:border-gray-700">
                <input type="text" placeholder="Search..." class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white"/>
            </div>
            <!-- 10+ Users -->
            <div class="contact-item p-3 flex items-center space-x-3 cursor-pointer" data-contact="sarah">
                <img src="https://randomuser.me/api/portraits/women/32.jpg" class="w-10 h-10 rounded-full"/>
                <div class="flex-1">
                    <p class="font-medium text-sm">Sarah Johnson</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Sounds good! I'll send over the files.</p>
                </div>
                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            </div>
            <div class="contact-item p-3 flex items-center space-x-3 cursor-pointer" data-contact="mike">
                <img src="https://randomuser.me/api/portraits/men/45.jpg" class="w-10 h-10 rounded-full"/>
                <div class="flex-1">
                    <p class="font-medium text-sm">Mike Chen</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Meeting at 3 PM</p>
                </div>
            </div>
            <div class="contact-item p-3 flex items-center space-x-3 cursor-pointer" data-contact="emma">
                <img src="https://randomuser.me/api/portraits/women/68.jpg" class="w-10 h-10 rounded-full"/>
                <div class="flex-1">
                    <p class="font-medium text-sm">Emma Davis</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Thanks for the help!</p>
                </div>
            </div>
            <div class="contact-item p-3 flex items-center space-x-3 cursor-pointer" data-contact="alex">
                <img src="https://randomuser.me/api/portraits/men/22.jpg" class="w-10 h-10 rounded-full"/>
                <div class="flex-1">
                    <p class="font-medium text-sm">Alex Kim</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Let's grab coffee</p>
                </div>
                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            </div>
            <div class="contact-item p-3 flex items-center space-x-3 cursor-pointer" data-contact="lisa">
                <img src="https://randomuser.me/api/portraits/women/44.jpg" class="w-10 h-10 rounded-full"/>
                <div class="flex-1">
                    <p class="font-medium text-sm">Lisa Park</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">New design is live!</p>
                </div>
            </div>
            <div class="contact-item p-3 flex items-center space-x-3 cursor-pointer" data-contact="james">
                <img src="https://randomuser.me/api/portraits/men/33.jpg" class="w-10 h-10 rounded-full"/>
                <div class="flex-1">
                    <p class="font-medium text-sm">James Wilson</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Check your email</p>
                </div>
            </div>
            <div class="contact-item p-3 flex items-center space-x-3 cursor-pointer" data-contact="olivia">
                <img src="https://randomuser.me/api/portraits/women/55.jpg" class="w-10 h-10 rounded-full"/>
                <div class="flex-1">
                    <p class="font-medium text-sm">Olivia Brown</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Happy birthday!</p>
                </div>
            </div>
            <div class="contact-item p-3 flex items-center space-x-3 cursor-pointer" data-contact="noah">
                <img src="https://randomuser.me/api/portraits/men/77.jpg" class="w-10 h-10 rounded-full"/>
                <div class="flex-1">
                    <p class="font-medium text-sm">Noah Lee</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">On my way</p>
                </div>
                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            </div>
            <div class="contact-item p-3 flex items-center space-x-3 cursor-pointer" data-contact="group">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-yellow-500 flex items-center justify-center text-white font-bold text-sm">GC</div>
                <div class="flex-1">
                    <p class="font-medium text-sm">Design Team</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Sarah: Final review at 4</p>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col relative">
            <!-- Empty State -->
            <div id="empty-state" class="empty-state">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <h3>Your messages</h3>
                <p>Send a message to start a chat.</p>
                <button id="start-chat-btn">Send message</button>
            </div>

            <!-- Messages -->
            <div id="popup-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900 hidden"></div>

            <!-- Input -->
            <div class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3">
                <div class="flex items-center space-x-2">
                    <button id="popup-attach" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-600 dark:text-gray-300"><i class="fas fa-paperclip"></i></button>
                    <button id="popup-emoji" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-600 dark:text-gray-300"><i class="fas fa-smile"></i></button>
                    <input type="file" id="popup-file" class="hidden" multiple accept="image/*"/>
                    <input type="text" id="popup-input" placeholder="Type a message..." class="flex-1 px-4 py-2 border dark:border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white"/>
                    <button id="popup-send" class="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div id="popup-emoji-picker" class="emoji-picker"></div>
                <div id="popup-attachment-preview" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        </div>
    </div>

    <div class="resize-handle"></div>
</div>

<script>
    /* ---------- DATA ---------- */
    const conversations = {
        sarah: { name: "Sarah Johnson", avatar: "https://randomuser.me/api/portraits/women/32.jpg", online: true,
            messages: [
                {type:"recv", text:"Hey! Are you free to review the design mockups?", time:"2:30 PM"},
                {type:"sent", text:"Yes, I can take a look now. Send them over!", time:"2:32 PM"},
                {type:"recv", text:"Here are the updated designs:", time:"2:35 PM", image:"https://images.unsplash.com/photo-1460925895917-afdab827c2fc?w=400"},
                {type:"recv", voice:true, duration:24, time:"2:36 PM"},
                {type:"recv", voice:true, duration:45, time:"2:37 PM"},
                {type:"sent", voice:true, duration:18, time:"2:38 PM"},
            ]
        },
        mike: { name: "Mike Chen", avatar: "https://randomuser.me/api/portraits/men/45.jpg", online: false,
            messages: [
                {type:"recv", text:"Hey, the meeting got moved.", time:"10:12 AM"},
                {type:"sent", text:"To when?", time:"10:13 AM"},
                {type:"recv", text:"3 PM today.", time:"10:15 AM"},
            ]
        },
        emma: { name: "Emma Davis", avatar: "https://randomuser.me/api/portraits/women/68.jpg", online: true,
            messages: [
                {type:"recv", text:"Thanks for the help with the presentation!", time:"11:20 AM"},
                {type:"sent", text:"No problem! Let me know if you need anything else.", time:"11:22 AM"},
            ]
        },
        alex: { name: "Alex Kim", avatar: "https://randomuser.me/api/portraits/men/22.jpg", online: true,
            messages: [
                {type:"recv", text:"Coffee tomorrow?", time:"3:15 PM"},
                {type:"sent", text:"Sure, 10 AM?", time:"3:16 PM"},
            ]
        },
        lisa: { name: "Lisa Park", avatar: "https://randomuser.me/api/portraits/women/44.jpg", online: false,
            messages: [
                {type:"recv", text:"New design is live! Check it out", time:"9:05 AM"},
            ]
        },
        james: { name: "James Wilson", avatar: "https://randomuser.me/api/portraits/men/33.jpg", online: true,
            messages: [
                {type:"recv", text:"Check your email for the contract", time:"1:40 PM"},
            ]
        },
        olivia: { name: "Olivia Brown", avatar: "https://randomuser.me/api/portraits/women/55.jpg", online: false,
            messages: [
                {type:"recv", text:"Happy birthday!", time:"12:00 PM"},
                {type:"sent", text:"Thank you!", time:"12:05 PM"},
            ]
        },
        noah: { name: "Noah Lee", avatar: "https://randomuser.me/api/portraits/men/77.jpg", online: true,
            messages: [
                {type:"recv", text:"On my way", time:"6:50 PM"},
            ]
        },
        group: { name: "Design Team", avatar: "", online: true,
            messages: [
                {type:"recv", text:"Sarah: Final review at 4", time:"3:30 PM"},
                {type:"sent", text:"Got it", time:"3:31 PM"},
            ]
        }
    };

    const voiceAudios = [
        'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
        'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
        'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
    ];

    /* ---------- DOM ---------- */
    const dmBtn = document.getElementById('dm-btn');
    const dmPopup = document.getElementById('dm-popup');
    const contactSidebar = document.getElementById('contact-sidebar');
    const backToList = document.getElementById('back-to-list');
    const popupAvatar = document.getElementById('popup-avatar');
    const popupName = document.getElementById('popup-name');
    const popupStatus = document.getElementById('popup-status');
    const popupMessages = document.getElementById('popup-messages');
    const emptyState = document.getElementById('empty-state');
    const popupInput = document.getElementById('popup-input');
    const popupSend = document.getElementById('popup-send');
    const popupAttach = document.getElementById('popup-attach');
    const popupFile = document.getElementById('popup-file');
    const popupEmojiBtn = document.getElementById('popup-emoji');
    const popupEmojiPicker = document.getElementById('popup-emoji-picker');
    const popupPreview = document.getElementById('popup-attachment-preview');
    const minimizeBtn = document.getElementById('minimize-btn');
    const maximizeBtn = document.getElementById('maximize-btn');
    const closeBtn = document.getElementById('close-popup');
    const startChatBtn = document.getElementById('start-chat-btn');

    let currentContact = null;

    /* ---------- EMOJI PICKER ---------- */
    ['grinning', 'smiling face with tears', 'red heart', 'thumbs up', 'fire', 'party popper'].forEach(e => {
        const span = document.createElement('span');
        span.className = 'cursor-pointer p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded';
        span.textContent = e;
        span.onclick = () => { popupInput.value += e; popupInput.focus(); popupEmojiPicker.classList.remove('show'); };
        popupEmojiPicker.appendChild(span);
    });

    /* ---------- OPEN CHAT ---------- */
    function openChat(contact) {
        currentContact = contact;
        const data = conversations[contact];
        popupAvatar.src = data.avatar || 'https://via.placeholder.com/40?text=GC';
        popupName.textContent = data.name;
        popupStatus.textContent = data.online ? 'Active now' : 'Offline';
        popupStatus.className = data.online ? 'text-xs text-green-200' : 'text-xs opacity-90';

        document.querySelectorAll('.contact-item').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-contact="${contact}"]`).classList.add('active');

        if (!dmPopup.classList.contains('maximized')) {
            contactSidebar.classList.add('hidden');
            backToList.classList.add('hidden');
        } else {
            contactSidebar.classList.remove('hidden');
            backToList.classList.remove('hidden');
        }

        emptyState.classList.add('hidden');
        popupMessages.classList.remove('hidden');
        renderMessages(contact);
        popupMessages.scrollTop = popupMessages.scrollHeight;
    }

    /* ---------- SHOW EMPTY STATE ---------- */
    function showEmptyState() {
        currentContact = null;
        popupAvatar.src = '';
        popupName.textContent = 'Messages';
        popupStatus.textContent = '';
        popupMessages.classList.add('hidden');
        emptyState.classList.remove('hidden');
        popupMessages.innerHTML = '';
        document.querySelectorAll('.contact-item').forEach(c => c.classList.remove('active'));
    }

    /* ---------- RENDER MESSAGES ---------- */
    function createMessageHTML(msg) {
        const isSent = msg.type === 'sent';
        const wrapper = document.createElement('div');
        wrapper.className = `message-item flex items-start space-x-2 ${isSent?'justify-end ml-auto':''} max-w-xs ${msg.image?'max-w-sm':''} group relative`;

        if (!isSent) {
            const avatar = document.createElement('img');
            avatar.src = conversations[currentContact].avatar || 'https://via.placeholder.com/32?text=GC';
            avatar.className = 'w-8 h-8 rounded-full flex-shrink-0';
            wrapper.appendChild(avatar);
        }

        const inner = document.createElement('div');
        if (isSent) inner.className = 'text-right';

        const bubble = document.createElement('div');
        bubble.className = `p-3 rounded-2xl ${isSent?'bg-indigo-600 text-white rounded-tr-none':'bg-white dark:bg-gray-700 rounded-tl-none'} shadow-sm`;

        if (msg.text) {
            const p = document.createElement('p');
            p.textContent = msg.text;
            bubble.appendChild(p);
        }
        if (msg.image) {
            const img = document.createElement('img');
            img.src = msg.image; img.className = 'attachment-preview mt-2';
            bubble.appendChild(img);
        }
        if (msg.voice) {
            const duration = msg.duration;
            const maxWidth = 300;
            const minWidth = 120;
            const width = Math.min(maxWidth, minWidth + (duration - 10) * 6);

            const voiceDiv = document.createElement('div');
            voiceDiv.className = 'voice-container';
            voiceDiv.style.width = `${width}px`;

            const audio = new Audio(voiceAudios[Math.floor(Math.random() * voiceAudios.length)]);
            let isPlaying = false;

            voiceDiv.innerHTML = `
            <button class="play-btn"><i class="fas fa-play"></i></button>
            <div class="voice-wave">
                ${Array.from({length: 10}, () => `<div class="voice-bar"></div>`).join('')}
            </div>
            <span class="time-counter">0:00 / ${formatTime(duration)}</span>
        `;

            const playBtn = voiceDiv.querySelector('.play-btn');
            const wave = voiceDiv.querySelector('.voice-wave');
            const timeCounter = voiceDiv.querySelector('.time-counter');

            const updateTime = () => {
                const current = Math.floor(audio.currentTime);
                timeCounter.textContent = `${formatTime(current)} / ${formatTime(duration)}`;
            };

            playBtn.addEventListener('click', () => {
                if (isPlaying) {
                    audio.pause();
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    wave.querySelectorAll('.voice-bar').forEach(b => b.style.animationPlayState = 'paused');
                } else {
                    audio.play();
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    wave.querySelectorAll('.voice-bar').forEach(b => b.style.animationPlayState = 'running');
                }
                isPlaying = !isPlaying;
            });

            audio.ontimeupdate = updateTime;
            audio.onended = () => {
                isPlaying = false;
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                wave.querySelectorAll('.voice-bar').forEach(b => b.style.animationPlayState = 'paused');
                updateTime();
            };

            wave.addEventListener('click', e => {
                const rect = wave.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audio.currentTime = percent * duration;
                updateTime();
            });

            bubble.appendChild(voiceDiv);
        }

        inner.appendChild(bubble);
        const time = document.createElement('span');
        time.className = `text-xs text-gray-500 dark:text-gray-400 ${isSent?'mr-2':'ml-2'}`;
        time.textContent = msg.time;
        inner.appendChild(time);
        wrapper.appendChild(inner);

        // 3-dot menu
        const actions = document.createElement('div');
        actions.className = 'message-actions absolute right-0 top-0 p-1';
        actions.innerHTML = '<button class="dots-btn p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded"><i class="fas fa-ellipsis-v text-xs"></i></button>';
        const menu = document.createElement('div');
        menu.className = 'dropdown-menu';
        menu.innerHTML = `
        <div class="dropdown-item"><i class="fas fa-reply"></i> Reply</div>
        <div class="dropdown-item"><i class="fas fa-edit"></i> Edit</div>
        <div class="dropdown-item text-red-600"><i class="fas fa-trash"></i> Delete</div>
        <div class="dropdown-item"><i class="fas fa-copy"></i> Copy</div>
    `;
        actions.appendChild(menu);
        wrapper.appendChild(actions);

        actions.querySelector('.dots-btn').addEventListener('click', e => {
            e.stopPropagation();
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            menu.classList.toggle('show');
        });

        return wrapper;
    }

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function renderMessages(contact) {
        popupMessages.innerHTML = '';
        conversations[contact].messages.forEach(m => {
            popupMessages.appendChild(createMessageHTML(m));
        });
        popupMessages.scrollTop = popupMessages.scrollHeight;
    }

    /* ---------- SEND MESSAGE ---------- */
    function sendMessage() {
        const text = popupInput.value.trim();
        if (!text && popupPreview.children.length === 0) return;
        const newMsg = {type:'sent', time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})};
        if (text) newMsg.text = text;
        popupPreview.querySelectorAll('img').forEach(img => { if (!newMsg.image) newMsg.image = img.src; });
        conversations[currentContact].messages.push(newMsg);
        popupMessages.appendChild(createMessageHTML(newMsg));
        popupMessages.scrollTop = popupMessages.scrollHeight;
        popupInput.value = ''; popupPreview.innerHTML = ''; popupFile.value = '';
    }
    popupSend.addEventListener('click', sendMessage);
    popupInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    /* ---------- CONTACT LIST ---------- */
    document.querySelectorAll('.contact-item').forEach(item => {
        item.addEventListener('click', () => openChat(item.dataset.contact));
    });

    backToList.addEventListener('click', () => {
        showEmptyState();
        if (dmPopup.classList.contains('maximized')) {
            contactSidebar.classList.remove('hidden');
        }
    });

    /* ---------- START CHAT BUTTON ---------- */
    startChatBtn.addEventListener('click', () => {
        alert("Select a contact from the list to start chatting!");
    });

    /* ---------- POPUP CONTROLS ---------- */
    dmBtn.addEventListener('click', () => {
        dmPopup.style.display = 'flex';
        dmPopup.classList.remove('minimized');
        showEmptyState();
        contactSidebar.classList.remove('hidden');
        backToList.classList.add('hidden');
    });

    minimizeBtn.addEventListener('click', () => dmPopup.classList.add('minimized'));
    maximizeBtn.addEventListener('click', () => {
        dmPopup.classList.toggle('maximized');
        if (dmPopup.classList.contains('maximized')) {
            contactSidebar.classList.remove('hidden');
            backToList.classList.remove('hidden');
            if (!currentContact) showEmptyState();
        } else if (currentContact) {
            contactSidebar.classList.add('hidden');
            backToList.classList.add('hidden');
        }
    });
    closeBtn.addEventListener('click', () => dmPopup.style.display = 'none');

    /* ---------- DRAG & RESIZE ---------- */
    let isDragging = false, isResizing = false, startX, startY, startWidth, startHeight;
    dmPopup.querySelector('.drag-handle').addEventListener('mousedown', e => {
        if (e.target.tagName === 'BUTTON') return;
        isDragging = true;
        startX = e.clientX - dmPopup.offsetLeft;
        startY = e.clientY - dmPopup.offsetTop;
    });
    dmPopup.querySelector('.resize-handle').addEventListener('mousedown', e => {
        isResizing = true;
        startX = e.clientX; startY = e.clientY;
        startWidth = dmPopup.offsetWidth; startHeight = dmPopup.offsetHeight;
        e.preventDefault();
    });
    document.addEventListener('mousemove', e => {
        if (isDragging) {
            dmPopup.style.left = (e.clientX - startX) + 'px';
            dmPopup.style.top = (e.clientY - startY) + 'px';
            dmPopup.style.right = 'auto'; dmPopup.style.bottom = 'auto';
        }
        if (isResizing) {
            const w = startWidth + (e.clientX - startX);
            const h = startHeight + (e.clientY - startY);
            if (w > 300) dmPopup.style.width = w + 'px';
            if (h > 300) dmPopup.style.height = h + 'px';
        }
    });
    document.addEventListener('mouseup', () => { isDragging = false; isResizing = false; });

    /* ---------- DARK MODE ---------- */
    document.getElementById('theme-toggle').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        document.getElementById('theme-toggle').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
        document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
    }

    /* Close dropdowns */
    document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
    });
</script>
</body>
</html>