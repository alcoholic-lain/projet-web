<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TUNISPACE CHAT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #ededfc; color: #cdd6f4; font-family: system-ui; height: 100vh; margin:0; display:flex; flex-direction:column; }
        #msg_box { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: .5rem; }
        .msg { align-self: flex-start; max-width: 80%; }
        .msg.private { align-self: flex-end; background: #6b9d78 !important; color: #43e79d; }
        .card { background: #b8beef; border: none; }
        .form-control { background: #313244; border: none; color: #cdd6f4; }
        .form-control:focus { background: #45475a; color: white; box-shadow: none; }
        #placeholder { text-align: center; color: #585b70; margin-top: 2rem; }
    </style>
</head>
<body class="p-3">

<div class="container-fluid d-flex flex-column h-100">
    <h2 class="text-center mb-3">TUNISPACE CHAT</h2>

    <div id="msg_box" class="card flex-grow-1 mb-3">
        <div id="placeholder">No messages yet...</div>
    </div>

    <div class="input-group mb-2">
        <input type="text" id="username_input" class="form-control" placeholder="Your name">
    </div>
    <div class="input-group mb-2">
        <input type="text" id="message_input" class="form-control" placeholder="Type a message...">
        <button id="send_btn" class="btn btn-primary" disabled>Send</button>
    </div>
    <div class="input-group">
        <input type="text" id="canal_input" class="form-control" placeholder="Private channel (optional)">
    </div>
</div>

<script>
    const ws = new WebSocket(`ws://${location.hostname}:500`);
    const msgBox = document.getElementById('msg_box');
    const placeholder = document.getElementById('placeholder');
    let currentChannel = '';

    const usernameInput = document.getElementById('username_input');
    const messageInput = document.getElementById('message_input');
    const canalInput = document.getElementById('canal_input');
    const sendBtn = document.getElementById('send_btn');

    function check() {
        sendBtn.disabled = !(usernameInput.value.trim() && messageInput.value.trim());
    }
    usernameInput.addEventListener('input', check);
    messageInput.addEventListener('input', check);

    function send() {
        const username = usernameInput.value.trim();
        const message = messageInput.value.trim();
        if (!username || !message) return;

        ws.send(JSON.stringify({ type: 'message', username, message }));
        messageInput.value = '';
        check();
    }

    sendBtn.onclick = send;
    messageInput.addEventListener('keypress', e => e.key === 'Enter' && send());

    canalInput.addEventListener('change', () => {
        const canal = canalInput.value.trim();
        if (canal !== currentChannel) {
            ws.send(JSON.stringify({ type: 'canal', canal }));
            currentChannel = canal;
        }
    });

    ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type !== 'message') return;

        if (placeholder) placeholder.remove();

        const div = document.createElement('div');
        div.className = 'msg card p-3';
        if (data.canal) div.classList.add('private');

        const prefix = data.canal ? `[${data.canal}]` : '[PUBLIC]';
        div.innerHTML = `<strong>${prefix} ${data.username}:</strong> ${data.message}`;

        msgBox.appendChild(div);
        msgBox.scrollTop = msgBox.scrollHeight;
    };

    ws.onclose = () => alert('Disconnected from server');
</script>
</body>
</html>